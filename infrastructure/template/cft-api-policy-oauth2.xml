<policies>
  <backend>
    <base/>
  </backend>
  <inbound>
    <base/>
    <validate-azure-ad-token header-name="Authorization" tenant-id="${cft_oauth2_tenant_id}" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized. Access token is missing or invalid.">
      <client-application-ids>
        <application-id>${cft_oauth2_client_id}</application-id>
      </client-application-ids>
      <audiences>
        <audience>${cft_oauth2_app_id}</audience>
      </audiences>
    </validate-azure-ad-token>
    <!-- remove OAuth2 Authorization header -->
    <set-header name="Authorization" exists-action="delete" />
    <!-- generate totp -->
    <send-request ignore-error="false" timeout="20" response-variable-name="s2sBearerToken" mode="new">
      <set-url>${s2s_base_url}/lease</set-url>
      <set-method>POST</set-method>
      <set-header name="Content-Type" exists-action="override">
        <value>application/json</value>
      </set-header>
      <set-body>@{
        return new JObject(
        new JProperty("microservice", "${s2s_client_id}"),
        new JProperty("oneTimePassword", "${one_time_password}")
        ).ToString();
        }</set-body>
    </send-request>
    <set-header name="ServiceAuthorization" exists-action="override">
      <value>@("Bearer " + ((IResponse)context.Variables["s2sBearerToken"]).Body.As&lt;string&gt;())</value>
    </set-header>
  </inbound>
  <outbound>
    <base/>
  </outbound>
  <on-error>
    <base/>
  </on-error>
</policies>
